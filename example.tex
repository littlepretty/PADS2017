\section{Motivating Example}
\label{Sec:MotivatingExample}

\tikzset {
        roundnode/.style={circle, draw=blue!80, fill=blue!5, very thick, minimum size=7mm},
        squarenode/.style={rectangle, draw=red!80, fill=red!5, very thick, minimum size=7mm},
        ->-/.style={->, line width=1.2pt},
        ==/.style={line width=1.6pt}
}

\begin{figure}[t]
\centering
\begin{tikzpicture}
\node[roundnode] (sw0) {SW0};
\node[roundnode] (sw1) [below left=2cm of sw0] {SW1};
\node[roundnode] (sw2) [below=1.1cm of sw0] {SW2};
\node[roundnode] (sw3) [below right=2cm of sw0] {SW3};
\node[squarenode] (net1) [below=1cm of sw1] {10.1.0.10/16};
\node[squarenode] (net2) [below=1cm of sw2] {10.0.0.10/8};
\node[squarenode] (net3) [below=1cm of sw3] {11.1.0.10/16};

\draw[-, line width=1.2pt] (sw0) -- node [near start, above] {0} node[near end, below] {1} (sw1);
\draw[-, line width=1.2pt] (sw0) -- node [near start, right] {1} node[near end, left] {1} (sw2);
\draw[-, line width=1.2pt] (sw0) -- node [near start, above] {2} node[near end, below] {1} (sw3);
\draw[-, line width=1.2pt] (sw1) -- node [near start, left] {0} (net1);
\draw[-, line width=1.2pt] (sw2) -- node [near start, left] {0} (net2);
\draw[-, line width=1.2pt] (sw3) -- node [near start, right] {0} (net3);
\end{tikzpicture}
\caption{A Tree-Topology SDN Network}
\label{Fig:ExampleNetworkTopo}
\end{figure}

\begin{figure*}
\centering
\subfloat[Forwarding Graph for EC1 and EC3] {
\begin{tikzpicture}
\node[roundnode] (sw2) {SW2};
\node[roundnode] (sw0) [left=of sw2] {SW0};
\node[roundnode] (sw1) [above left=of sw0] {SW1};
\node[roundnode] (sw3) [below left=of sw0] {SW3};
\node[squarenode, align=center] (ec13) [right=of sw2] {EC1: 10.0.*.*\\EC3: 10.2.0.0-10.255.255.255};

\draw[->-] (sw0) -- node [near start, above] {1} node[near end, above] {1} (sw2);
\draw[->-] (sw1) -- node [near start, above] {1} node[near end, above] {0} (sw0);
\draw[->-] (sw3) -- node [near start, above] {1} node[near end, above] {2} (sw0);
\draw[->-] (sw2) -- node [near start, above] {0} (ec13);
\end{tikzpicture}
\label{Fig:ExampleForwardingEC13}
}

\subfloat[Forwarding Graph for EC2] {
\begin{tikzpicture}
\node[roundnode] (sw1) {SW1};
\node[roundnode] (sw0) [left=of sw2] {SW0};
\node[roundnode] (sw2) [above left=of sw0] {SW2};
\node[roundnode] (sw3) [below left=of sw0] {SW3};
\node[squarenode] (ec2) [right=of sw1] {EC2: 10.1.*.*};

\draw[->-] (sw0) -- node [near start, above] {0} node[near end, above] {1} (sw1);
\draw[->-] (sw2) -- node [near start, above] {1} node[near end, above] {1} (sw0);
\draw[->-] (sw3) -- node [near start, above] {1} node[near end, above] {2} (sw0);
\draw[->-] (sw1) -- node [near start, above] {0} (ec2);
\end{tikzpicture}
\label{Fig:ExampleForwardingEC2}
}
\subfloat[Forwarding Graph for EC4] {
\begin{tikzpicture}
\node[roundnode] (sw3) {SW3};
\node[roundnode] (sw0) [left=of sw3] {SW0};
\node[roundnode] (sw1) [above left=of sw0] {SW1};
\node[roundnode] (sw2) [below left=of sw0] {SW2};
\node[squarenode] (ec4) [right=of sw3] {EC4: 11.1.*.*};

\draw[->-] (sw0) -- node [near start, above] {2} node[near end, above] {2} (sw3);
\draw[->-] (sw1) -- node [near start, above] {1} node[near end, above] {0} (sw0);
\draw[->-] (sw2) -- node [near start, above] {1} node[near end, above] {1} (sw0);
\draw[->-] (sw3) -- node [near start, above] {0} (ec4);
\end{tikzpicture}
\label{Fig:ExampleForwardingEC4}
}
\caption{Forward Graph for Each EC}
\label{Fig:ExampleForwardingGraphs}
\end{figure*}

\begin{table*}[t]
\caption{Forwarding rules on each OpenFlow switch in the 3-ary tree topology network}
\begin{center}
\begin{tabular}{c|clc}
\hline
Switch & Priority & Match Field & Action\\
\hline
\hline
\multirow{3}{2em}{SW0} & 10 & NW\_DST=10.1.*.* & FWD: OUT\_PORT=0 \\
                       & 1  & NW\_DST=10.*.*.* & FWD: OUT\_PORT=1 \\
                       & 1  & NW\_DST=11.1.*.* & FWD: OUT\_PORT=2 \\
\hline
\multirow{3}{2em}{SW1} & 10 & IN\_PORT=1, NW\_DST=10.1.*.* & FWD: OUT\_PORT=0 \\
                       & 1  & IN\_PORT=0, NW\_DST=10.*.*.* & FWD: OUT\_PORT=1 \\
                       & 1  & IN\_PORT=0, NW\_DST=11.1.*.* & FWD: OUT\_PORT=1 \\
\hline
\multirow{3}{2em}{SW2} & 10 & IN\_PORT=0, NW\_DST=10.1.*.* & FWD: OUT\_PORT=1 \\
                       & 1  & IN\_PORT=1, NW\_DST=10.*.*.* & FWD: OUT\_PORT=0 \\
                       & 1  & IN\_PORT=0, NW\_DST=11.1.*.* & FWD: OUT\_PORT=1 \\
\hline
\multirow{3}{2em}{SW3} & 10 & IN\_PORT=1, NW\_DST=11.1.*.* & FWD: OUT\_PORT=0 \\
                       & 1  & IN\_PORT=0, NW\_DST=10.*.*.* & FWD: OUT\_PORT=1 \\
                       & 1  & IN\_PORT=0, NW\_DST=10.1.*.* & FWD: OUT\_PORT=1 \\
\hline
\end{tabular}
\end{center}
\label{Tab:OriginalFlowTable}
\end{table*}

\begin{table*}[t]
\caption{Forwarding Rules on the ``Big OpenFlow Switch"}
\begin{center}
\begin{tabular}{c|clc}
\hline
Switch & Priority & Match Field & Action\\
\hline
\hline
\multirow{4}{2em}{SW}  & 10 & NW\_DST=10.0.*.* & FWD OUT\_PORT=1 \\
                       & 10 & NW\_DST=10.1.*.* & FWD OUT\_PORT=0 \\
                       & 10 & NW\_DST=11.1.*.* & FWD OUT\_PORT=2 \\
                       & 10 & NW\_DST=10.2.0.0-10.255.255.255 & FWD OUT\_PORT=1 \\
\hline
\end{tabular}
\end{center}
\label{Tab:CompressedFlowTable}
\end{table*}

In this section, we describe our idea in a concrete network example and
walk through our method of how to compressing a SDN network to a ``big switch" module.
Let's consider the tree-topology network connected by 4 OpenFlow switches,
as shown in Figure~\ref{Fig:ExampleNetworkTopo}.
Centralized SDN controller(not shown in the figure) installs the rules shown in
Table~\ref{Tab:OriginalFlowTable} to each switch so that connection is established
for three subnets.
We assume the network has been in a stationary state, e.g. rules are already available
on each OpenFlow switch and there is no dynamic events occur such as link down
or rule modification.
SW0 then works properly as an \textbf{aggregate switch} to route traffic
between different subnets.
SW1, SW2 and SW3 play as \textbf{edge switches}, switches at the leave of the topology,
for three subnets respectively.
In this very special case, there is only one host connected to each edge switch.

Our approach abstracts the network composed of both aggregate switch and edge switches
to one ``big switch" that has logically equivalent functions.
The first step in the abstraction process is to extract \textit{equivalence classes}
through the OpenFlow rules from any devices in the network.
As formally defined later in Section~\ref{Sec:Design} and in \cite{Veriflow}, equivalence class (EC) is
the set of packets that experience identical forwarding action at \textbf{any} network device.
This concept is proposed to confine network verification activities to the minimal
effected set of packets\cite{Veriflow}.
In our approach, we utilize EC to merge all the rules on a set of switches.
For example, the flow rules shown in Table~\ref{Tab:OriginalFlowTable} can be sliced into
4 \textbf{disjoint} ECs based on the NW\_DST match field:
\begin{itemize}
\item Packets in EC1 is destined to network address 10.0.*.*.
\item Packets in EC2 is going to hosts with address 10.1.*.*.
\item Packets going to the address range from 10.2.0.0 to 10.255.255.255 belongs to EC3
\item Packets in EC4 goes to subnet 11.1.*.*. 
\end{itemize}
One thing to notice is that match field IN\_PORT cannot be used in identifying ECs,
since it is not packet-dependent but topology-dependent filed.

After identifying all the equivalence classes from the rule set,
we generate \textit{forwarding graph} which models how packets within an EC will be
forwarded through the network\cite{Veriflow}.
The node in a forwarding graph represents EC at a network device;
the directed edge represents how the network device forward the EC.
The sink nodes (shown as red rectangle node) is not part of the forwarding graph
but are drawn for recognizing which EC this forwarding graph belongs to.
If we skip the process of minimizing number of ECs from the rules,
each equivalence class will have exactly one forwarding graph.
Forwarding graph for all four ECs are shown separately in
Figure~\ref{Fig:ExampleForwardingGraphs}.
Notice that \{EC1, EC2, EC3, EC4\} is not the minimal set of ECs in the network.
In fact, EC1 and EC3 can be merged together because packets in both classes are forwarded
identically at any network device.
This is shown in Figure~\ref{Fig:ExampleForwardingEC13} as EC1 and EC3 share the same
forwarding graph.

We finish the abstraction by generating a new set of forwarding rules that are to be
installed on the ``big switch".
This process can be efficiently by considering only these ECs that
traverses edge switches in the abstracted network.
Table~\ref{Tab:CompressedFlowTable} shows the resulting rules that will be installed in
SW in Figure~\ref{Fig:ExampleBigSwitch}.

\begin{figure}[t]
\centering
\begin{tikzpicture}
\node[roundnode, minimum size=15mm, align=center] (sw) {Big\\Switch};
\node[squarenode, align=center] (ec13) [below=1.3cm of sw] {10.0.0.10/8};
\node[squarenode] (ec2) [below left=2cm of sw] {10.1.0.10/16};
\node[squarenode] (ec4) [below right=2cm of sw] {11.1.0.10/16};

\draw[-, line width=1.2pt] (sw) -- node [near start, above] {0} (ec2);
\draw[-, line width=1.2pt] (sw) -- node [near start, right] {1} (ec13);
\draw[-, line width=1.2pt] (sw) -- node [near start, above] {2} (ec4);
\end{tikzpicture}
\caption{Compressed SDN Network for Scalable Simulation}
\label{Fig:ExampleBigSwitch}
\end{figure}

The resulting one-switch network functions identical to the tree-topology network,
in the eyes of the three hosts(possibly emulated or simulated).
In contrast, the number of switches we need to emulate is reduced from four to one;
more importantly, the number of rules in the network is reduced from twelve to four.
If we confine the rules to these that (1) only match NW\_DST field;
(2) only have forwarding actions,
the total number of rules will be proportional to the number of ECs in the
original SDN network, comparing to $O(S\times P)$ where $S$ is the number of switches
and $P$ is the number of address prefixes.


